
#include <asm/uaccess.h> 
#include <linux/interrupt.h> 
#include <linux/irq.h> 
#include <asm/irq.h>

#include <linux/init.h> 
#include <linux/module.h> 
#include <linux/types.h> 
#include <linux/fs.h> 
#include <linux/proc_fs.h> 
#include <linux/device.h> 
#include <linux/miscdevice.h>
#include <asm/uaccess.h>


static long mymisc_ioctrl(struct file *file, unsigned int cmd, unsigned long arg); 

static irqreturn_t myirq_isr_handler(int irq, void *dev_id) 
{ 
    pr_info("myirq_isr_handler!!.\n"); 
    return IRQ_HANDLED; 
}

static long mymisc_ioctrl(struct file *file, unsigned int cmd, unsigned long arg)
{
    return 0;
}

static const struct file_operations mymisc_fops = { 
    .owner = THIS_MODULE, 
    .unlocked_ioctl = mymisc_ioctrl, 
};


static struct miscdevice mymisc_dev =
{
    MISC_DYNAMIC_MINOR,
    "mymisc",
    &mymisc_fops,
};

static int __init mymisc_init(void)
{
    pr_info("mymisc_init begin.\n");
    int ret = misc_register(&mymisc_dev);

    if (ret) 
    { 
        pr_info("Unable to register mymisc device\n"); 
    } 
    printk(KERN_INFO "mymisc init ok ...\r\n"); 

    ret = request_irq(VECTOR_INT_P_GPIO4, myirq_isr_handler,0,"myirq_isr_handler", NULL);
    if (ret) 
    { 
        pr_info("Unable to register mymisc device\n"); 
    } 
    printk(KERN_INFO "mymisc init ok ...\r\n"); 
    return 0;
}


static void __exit mymisc_exit(void)
{
    free_irq(VECTOR_INT_P_GPIO4, NULL);
    misc_deregister(&mymisc_dev);
}


MODULE_LICENSE("GPL");

module_init(mymisc_init);
module_exit(mymisc_exit);


