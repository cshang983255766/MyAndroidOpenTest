#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <stdio.h>
#include <termios.h>
#include <unistd.h>

#define MX_IOC_MAGIC            'z'

#define MDRV_MX_INIT            _IO(MX_IOC_MAGIC, 0) 
#define MDRV_MX_GET             _IOWR(MX_IOC_MAGIC, 1, int) 
#define MDRV_MX_SET             _IOWR(MX_IOC_MAGIC, 2, int) 
#define MDRV_MX_SETGET          _IOWR(MX_IOC_MAGIC, 3, int)

#define MX_IOC_MAXNR            4

#define MX_CTRL_FILE  "/dev/mxctl"
#define RR_EOK 			0
#define RR_ERR 			-1

static int mx_fd = -1;

static int MX_Init(void)
{
    int ret = RR_ERR;
        
    if (mx_fd < 0){
        mx_fd = open(MX_CTRL_FILE, O_RDWR);
    }
   
    if (mx_fd >= 0) {       
        ret = ioctl(mx_fd, MDRV_MX_INIT);

        if (ret < 0) {
            printf(">>>>MX Init failed. \n");
            return RR_ERR;
        }
    } else {
        printf("OPEN  MXCTL FILE ERROR! ");
    }
    
    return ret;    
}

static int MX_Get(int *pval)
{
    int ret = RR_ERR;
        
    if (mx_fd < 0){
        mx_fd = open(MX_CTRL_FILE, O_RDWR);
    }
   
    if (mx_fd >= 0) {       
        ret = ioctl(mx_fd, MDRV_MX_GET, pval);

        if (ret < 0) {
            printf(">>>>MX Get failed. \n");
            return RR_ERR;
        }
    } else {
        printf("OPEN  MXCTL FILE ERROR! ");
    }
    
    return ret;    
}

static int MX_Set(int val)
{
    int ret = RR_ERR;
    
    if (mx_fd < 0){
        mx_fd = open(MX_CTRL_FILE, O_RDWR);
    }
   
    if (mx_fd >= 0) {       
        ret = ioctl(mx_fd, MDRV_MX_SET, &val);

        if (ret < 0) {
            printf(">>>>MX Set failed. \n");
            return RR_ERR;
        }
    } else {
        printf("OPEN  MXCTL FILE ERROR! ");
    }
    
    return ret;    
}

static int MX_SetGet(int *pval)
{
    int ret = RR_ERR;
    
    if (mx_fd < 0){
        mx_fd = open(MX_CTRL_FILE, O_RDWR);
    }
   
    if (mx_fd >= 0) {       
        ret = ioctl(mx_fd, MDRV_MX_SETGET, pval);

        if (ret < 0) {
            printf(">>>>MX SetGet failed. \n");
            return RR_ERR;
        }
    } else {
        printf("OPEN  MXCTL FILE ERROR! ");
    }
    
    return ret;    
}


static int help_info(void){
	printf("\nUsage: \n");
	printf("MX 0 - Init.\n");
	printf("MX 1 - Get.\n");
	printf("MX 2 - Set.\n");
	printf("MX 3 - SetGet.\n");
	
	return 0;
}


int main(int argc,char *argv[] )
{
	int val;
	switch(argc){
	case 2 :{
		if(!strcmp(argv[1],"-h") || !strcmp(argv[1],"--help")){
			help_info();
		}else if(!strcmp(argv[1],"0")) {
		    MX_Init();
		}else if(!strcmp(argv[1],"1")) {
		    MX_Get(&val);
		    printf("GetValue = %d.\r\n", val);
		}else {
			printf("cmd error!\n");
			exit(-1);
		}
	}break;
	case 3 :{	
	    val = atoi(argv[2]);	    
	    if(!strcmp(argv[1],"2")) {
		    MX_Set(val);
		}else if(!strcmp(argv[1],"3")) {
		    MX_SetGet(&val);
		    printf("SetGetValue = %d.\r\n", val);
		}else {
			printf("cmd error!\n");
			exit(-1);
		}
	    
	}break;
	default:
		printf("Please input --help or -h  for help information\n");
	}		
	return 0;
}
